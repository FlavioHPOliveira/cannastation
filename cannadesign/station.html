<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=0" />
  <script src="https://kit.fontawesome.com/ae320467ae.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="src/css/styles.css">
  <link rel="stylesheet" href="src/css/header.css">
  <link rel="stylesheet" href="src/css/status.css">
  <link rel="stylesheet" href="src/css/cards.css">
  <link rel="stylesheet" href="src/css/sensor.css">
  <link rel="stylesheet" href="src/css/control.css">
  <link rel="stylesheet" href="src/css/modal.css">
  <title>Cannastation</title>
</head>
<body>
  <script>

  // auth().onAuthStateChanged(async (user) => {
  //       // console.log('< FETCH USER MIDDLEWARE > ', user)
  //       if (user) resolve(user);
  //       if (!user) resolve({});
  //     });

    

    var token = localStorage.getItem("token");
    console.log("The Value Received is " + token);

    ////////////////////////////////SOCKET STUFF//////////////////////////////////
    // Create WebSocket connection.
    const socket = new WebSocket(`ws://localhost:3000/?token=${token}?clientType=app`);

    const GPIO_LIGHT = 5
    const GPIO_FAN = 4
    const GPIO_EXHAUST = 0
    const GPIO_WATER = 2

    // Connection opened
    socket.addEventListener('open', function (event) {
        console.log('Connected to WS Server')
    });

    // Listen for messages
    socket.addEventListener('message', function (event) {
        console.log('Message from server ', event.data);

        try{
          const sensorData = JSON.parse(event.data)
          if(sensorData?.type == "sensor" ){
            document.getElementById("temperature").innerHTML = sensorData?.temperature; 
            document.getElementById("airHumidity").innerHTML = sensorData?.airHumidity;
            document.getElementById("soilMoisture").innerHTML = sensorData?.soilMoisture;
          }else if( sensorData?.type == "controlState" ){
            
            //SET UP Cards classes
            //LIGHT
            //function approach...not sure need this.
            setLightCardStatus(sensorData?.lightOn)

            //FAN
            if( sensorData?.fanOn == 1 ){
              fanIcon.classList.remove('color__green')
              fanIcon.classList.add('color__red')
              fanControlCard.classList.remove('control__on')
              fanControlCard.classList.add('control__off')
              fanPowerIcon.classList.remove('color__green')
              fanPowerIcon.classList.add('color__red')
            }else if(sensorData?.fanOn == 0){
              fanIcon.classList.remove('color__red')
              fanIcon.classList.add('color__green')
              fanControlCard.classList.remove('control__off')
              fanControlCard.classList.add('control__on')
              fanPowerIcon.classList.remove('color__red')
              fanPowerIcon.classList.add('color__green')
            }

            //EXHAUST
            if( sensorData?.exhaustOn == 1 ){
              exhaustIcon.classList.remove('color__green')
              exhaustIcon.classList.add('color__red')
              exhaustControlCard.classList.remove('control__on')
              exhaustControlCard.classList.add('control__off')
              exhaustPowerIcon.classList.remove('color__green')
              exhaustPowerIcon.classList.add('color__red')

            }else if(sensorData?.exhaustOn == 0){
              exhaustIcon.classList.remove('color__red')
              exhaustIcon.classList.add('color__green')
              exhaustControlCard.classList.remove('control__off')
              exhaustControlCard.classList.add('control__on')
              exhaustPowerIcon.classList.remove('color__red')
              exhaustPowerIcon.classList.add('color__green')
            }

            //WATER
            if( sensorData?.waterOn == 1 ){
              waterIcon.classList.remove('color__green')
              waterIcon.classList.add('color__red')
              waterControlCard.classList.remove('control__on')
              waterControlCard.classList.add('control__off')
              waterPowerIcon.classList.remove('color__green')
              waterPowerIcon.classList.add('color__red')

            }else if(sensorData?.waterOn == 0){
              waterIcon.classList.remove('color__red')
              waterIcon.classList.add('color__green')
              waterControlCard.classList.remove('control__off')
              waterControlCard.classList.add('control__on')
              waterPowerIcon.classList.remove('color__red')
              waterPowerIcon.classList.add('color__green')

            }

            //Remove loading and Make cards visible.
            document.getElementById("controlLoading").style.display = "none";
            const controlMainCards = document.getElementById("controlMainCards");
            controlMainCards.classList.remove("control__cards__hidden")

          }
          
        }catch(e){
          console.log(e)
        }

    });

    const sendMessage = () => {
        socket.send('Hello From Client1!');
    }

    const sendMessageON = () => {
        socket.send('ON');
    }
    const sendMessageOFF = () => {
        socket.send('OFF');
    }
    //////////////////////////////// END OF SOCKET STUFF//////////////////////////////////

    //I am going to use function or just put inside message? wait...
    const setLightCardStatus = (onOff) => {
      if(onOff == 1){
          lightIcon.classList.remove('color__green')
          lightIcon.classList.add('color__red')
          lightControlCard.classList.remove('control__on')
          lightControlCard.classList.add('control__off')
          lightPowerIcon.classList.remove('color__green')
          lightPowerIcon.classList.add('color__red')
      }else if(onOff == 0){
          lightIcon.classList.remove('color__red')
          lightIcon.classList.add('color__green')
          lightControlCard.classList.remove('control__off')
          lightControlCard.classList.add('control__on')
          lightPowerIcon.classList.remove('color__red')
          lightPowerIcon.classList.add('color__green')
      }
    }
    //////////////////////////////// LIGHT CONTROL //////////////////////////////////
    const sendMessageLight = () => {

        const lightButton = document.getElementById("controlLight")
        const lightIcon = document.getElementById("lightIcon")
        const lightControlCard = document.getElementById("lightControlCard")
        const lightPowerIcon = document.getElementById("lightPowerIcon")

        console.log(lightButton.value);
        let lightControlMessage = ''

        //Sending GPIO Inverting 0 and 1 because for the board 0 means ON, and 1 means OFF.
        if(lightButton.value == 1){
          lightControlMessage = `{"type":"control", "control":"light", "GPIO":${GPIO_LIGHT}, "OnOff":1}`
          lightButton.value = 0

        }
        else if(lightButton.value == 0){
          lightControlMessage = `{"type":"control", "control":"light", "GPIO":${GPIO_LIGHT}, "OnOff":0}`
          lightButton.value = 1
        }

        socket.send(lightControlMessage);
    }
    //////////////////////////////// END OF LIGHT CONTROL //////////////////////////////////

    //////////////////////////////// FAN CONTROL //////////////////////////////////
    const sendMessageFan = () => {

    const fanButton = document.getElementById("controlFan")
    const fanIcon = document.getElementById("fanIcon")
    const fanControlCard = document.getElementById("fanControlCard")
    const fanPowerIcon = document.getElementById("fanPowerIcon")

    console.log(fanButton.value);
    let fanControlMessage = ''

    //Sending GPIO Inverting 0 and 1 because for the board 0 means ON, and 1 means OFF.
    if(fanButton.value == 1){
      fanControlMessage = `{"type":"control", "control":"fan", "GPIO":${GPIO_FAN}, "OnOff":1}`
      fanButton.value = 0
    }
    else if(fanButton.value == 0){
      fanControlMessage = `{"type":"control", "control":"fan", "GPIO":${GPIO_FAN}, "OnOff":0}`
      fanButton.value = 1
    }

    socket.send(fanControlMessage);
    }
    //////////////////////////////// END OF FAN CONTROL //////////////////////////////////

   //////////////////////////////// EXHAUST CONTROL //////////////////////////////////
   const sendMessageExhaust = () => {

    const exhaustButton = document.getElementById("controlExhaust")
    const exhaustIcon = document.getElementById("exhaustIcon")
    const exhaustControlCard = document.getElementById("exhaustControlCard")
    const exhaustPowerIcon = document.getElementById("exhaustPowerIcon")

    console.log(exhaustButton.value);
    let exhaustControlMessage = ''

    //Sending GPIO Inverting 0 and 1 because for the board 0 means ON, and 1 means OFF.
    if(exhaustButton.value == 1){
      exhaustControlMessage = `{"type":"control", "control":"exhaust", "GPIO":${GPIO_EXHAUST}, "OnOff":1}`
      exhaustButton.value = 0
    }
    else if(exhaustButton.value == 0){
      exhaustControlMessage = `{"type":"control", "control":"exhaust", "GPIO":${GPIO_EXHAUST}, "OnOff":0}`
      exhaustButton.value = 1
    }

    socket.send(exhaustControlMessage);
    }
    //////////////////////////////// END OF EXHAUST CONTROL //////////////////////////////////

    //////////////////////////////// WATER CONTROL //////////////////////////////////
    const sendMessageWater = () => {

    const waterButton = document.getElementById("controlWater")
    const waterIcon = document.getElementById("waterIcon")
    const waterControlCard = document.getElementById("waterControlCard")
    const waterPowerIcon = document.getElementById("waterPowerIcon")

    console.log(waterButton.value);
    let waterControlMessage = ''

    //Sending GPIO Inverting 0 and 1 because for the board 0 means ON, and 1 means OFF.
    if(waterButton.value == 1){
      waterControlMessage = `{"type":"control", "control":"water", "GPIO":${GPIO_WATER}, "OnOff":1}`
      waterButton.value = 0
    }
    else if(waterButton.value == 0){
      waterControlMessage = `{"type":"control", "control":"water", "GPIO":${GPIO_WATER}, "OnOff":0}`
      waterButton.value = 1
    }

    socket.send(waterControlMessage);
    }
    //////////////////////////////// END OF WATER CONTROL //////////////////////////////////

    // //Water Control
    // const sendMessageWater = () => {
    // const waterCheckbox = document.getElementById("controlW ater")
    // //Inverting 0 and 1 because for the board 0 means ON, and 1 means OFF.
    // console.log('clicked checkbox',Number(!waterCheckbox.checked))
    // const waterControlMessage = `{"type":"control", "control":"water", "GPIO":${GPIO_WATER}, "OnOff":${Number(!waterCheckbox.checked)}}`

    // socket.send(waterControlMessage);

    // }

    //////////////////////////////// AUTOMATIC LIGHT CONTROL //////////////////////////////////
    //const btnAutoLight = document.getElementById("auto_light_apply")
    const sendMessageAutoLight = () => {

      console.log('btn light clicked')

      const lightAutoJSON = {
        type: "control_auto",
        control: "light",
        hourOn: parseInt(document.getElementById("hourOn").value),
        hourOff: parseInt(document.getElementById("hourOff").value),
        minuteOn: parseInt(document.getElementById("minuteOn").value),
        minuteOff: parseInt(document.getElementById("minuteOff").value)
      }

      const lightAutoStringfy = JSON.stringify(lightAutoJSON)
      console.log(lightAutoStringfy)
      socket.send(lightAutoStringfy);

    }
    

</script>

  <header>
    <a class="header__logo" href=""><img src="src/img/green-cannabis-leaf-simple-drawing-vector.jpg" alt="logo"></img>Cannastation</a>
    <nav>
        <ul class="nav__links">
            <li><i class="fas fa-info-circle nav__icon"></i>How it works</li>
            <li><i class="fas fa-hand-holding-heart nav__icon"></i>Community</li>
            <li><i class="fas fa-money-check-alt nav__icon"></i>Plans</li>
        </ul>
    </nav>
    <nav>
      <ul class="nav__links">
        <li class="nav__board selected"><i class="fas fa-solid fa-leaf nav__icon"></i>My Station</li>
        <li><span class="fa fa-user nav__icon"></span>Profile</li>
      </ul>    
    </nav>
    
  </header>

  <main>

    <section class="status">
      <div class="status__welcome">
        <h2>Welcome Flavio  üëã</h2>
        
        <h3>Set up your station and start growing your seeds!</h3>
      </div>
      <div class="status__content">
        <ul>
          <h4>Board Status: Online <span class="fas fa-solid fa-power-off color__green"> </span> &nbsp&nbsp&nbsp Last Update: 28/12/2021 18:00  üïí</h4>
          
        </ul>
      </div>
      
    </section>
    
    <section class="main">
      <div class="main__data">
        <h3 class="main__title">üß≠ Sensors</h3>
        <ul class='main__cards'>
          <li class='sensor__card'>
            <h3>Temperature</h3>
            <i class="fas fa-solid fa-temperature-high fa-2x color__green"></i>
            <h2 id="temperature">Loading...</h2>
          </li>
          <li class='sensor__card'>
            <h3>Air Humidity</h3>
            <i class="fas fa-solid fa-wind fa-2x color__red"></i>
            <h2 id="airHumidity">Loading...</h2>
          </li>
          <li class='sensor__card'>
            <h3>Soil Humidity</h3>
            <i class="fas fa-solid fa-spa fa-2x color__green"></i>
            <h2 id="soilMoisture">Loading...</h2>
          </li>
        </ul>
      </div>
    </section>

    <section class="main">
      <div class="main__data">
        <h3 class="main__title">üïπÔ∏è Controls</h3>
        <h3 id="controlLoading" class="control__loading">Loading...</h3>
        <ul id="controlMainCards" class='main__cards control__cards__hidden'>
          
            <li id="lightControlCard" class='control__card control__on'>
              <div class="control__card__head">
                <h3>Light</h3>
                <i id="lightIcon" class="far fa-lightbulb fa-lg color__green fa-2x"></i>
              </div>
              <div class="control__card__lines">
                <ul class="control__line">
                  <li>Online</li>
                  <button onclick="sendMessageLight()" id="controlLight" class="control__buttonOnOff" value=1>
                    <li id="lightPowerIcon" class="fas fa-solid fa-power-off color__green"></li>
                  </button>
                </ul>

                <ul class="control__line">
                  <li>Mode</li>
                  <li>Manual</li>
                </ul>

                <ul class="control__line">
                  <button id="automaticLight" class="control__automatic">Automatic</button>
                </ul>    
              </div>
            </li>

            <li id="fanControlCard" class='control__card control__off'>
              <div class="control__card__head">
                <h3>Fan</h3>
                <i id="fanIcon" class="fas fa-solid fa-fan color__red fa-2x"></i>
              </div>
              <div class="control__card__lines">
                <ul class="control__line">
                  <li>Offline</li>
                  <button onclick="sendMessageFan()" id="controlFan" class="control__buttonOnOff" value=0>
                    <li id="fanPowerIcon" class="fas fa-solid fa-power-off color__red"></li>
                  </button>
                </ul>

                <ul class="control__line">
                  <li>Mode</li>
                  <li>Manual</li>
                </ul>

                <ul class="control__line">
                  <button class="control__automatic">Automatic</button>
                </ul>    
              </div>
            </li>

            <li id="exhaustControlCard" class='control__card control__on'>
              <div class="control__card__head">
                <h3>Exaust</h3>
                <i id="exhaustIcon" class="fas fa-solid fa-soap fa-2x color__green"></i>
              </div>
              <div class="control__card__lines">
                <ul class="control__line">
                  <li>Online</li>
                  <button onclick="sendMessageExhaust()" id="controlExhaust" class="control__buttonOnOff" value=0>
                  <li id="exhaustPowerIcon" class="fas fa-solid fa-power-off color__green"></li>
                  </button>
                </ul>
          
                <ul class="control__line">
                  <li>Mode</li>
                  <li>Manual</li>
                </ul>

                <ul class="control__line">
                  <button class="control__automatic">Automatic</button>
                </ul>    
              </div>
            </li>


            <li id="waterControlCard" class='control__card control__off'>
              <div class="control__card__head">
                <h3>Water</h3>
                <i id="waterIcon" class="fas fa-solid fa-shower fa-2x color__red"></i>
              </div>
              <div class="control__card__lines">
                <ul class="control__line">
                  <li>Offline</li>
                  <button onclick="sendMessageWater()" id="controlWater" class="control__buttonOnOff" value=0>
                    <li id="waterPowerIcon" class="fas fa-solid fa-power-off color__red"></li>
                  </button>
                </ul>
                

                <ul class="control__line">
                  <li>Mode</li>
                  <li>Manual</li>
                </ul>

                <ul class="control__line">
                  <button class="control__automatic">Automatic</button>
                </ul>    
              </div>
            </li>

            </li>
         
           
        </ul>
      </div>
    </section>
  </main>

  <!-- The Modal -->
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2>üí° Light Automatic Settings</h2>
      <div class="automatic__settings">
        <p>Turn ON At:</p>
        <label for="hourOn">Hour:</label>
        <input type="text" id="hourOn">
        <label for="minuteOn">Minutes:</label>
        <input type="text" id="minuteOn">

        <p>Turn OFF At:</p>
        <label for="hourOff">Hour:</label>
        <input type="text" id="hourOff">
        <label for="minuteOff">Minutes:</label>
        <input type="text" id="minuteOff">
        <br/>
        <br/>
        <button id="auto_light_apply" onClick="sendMessageAutoLight()" class="control__buttonOnOff">Apply</button>

      </div>
    </div>

  </div>
  
  <footer></footer>
  
  <script src='dist/station.bundle.js'></script>

</body>
</html>